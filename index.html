!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WabTech AgriSense - Climate-Smart Agriculture Platform</title>
  
  <!-- SDK References -->
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* ... existing CSS styles ... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%); color: #2d3748; overflow-x: hidden; }
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; min-height: 100%; display: flex; flex-direction: column; }
    .header { background: rgba(255, 255, 255, 0.98); padding: 24px 32px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); margin-bottom: 24px; border-left: 6px solid #10b981; }
    .header-content { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
    .logo-section { display: flex; align-items: center; gap: 16px; }
    .logo { width: 56px; height: 56px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .brand-text h1 { font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
    .brand-text p { font-size: 14px; color: #6b7280; font-weight: 500; }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    .user-badge { background: #f3f4f6; padding: 8px 16px; border-radius: 8px; font-size: 14px; color: #374151; font-weight: 500; }
    .main-content { display: grid; grid-template-columns: 1fr 380px; gap: 24px; flex: 1; }
    .query-panel { background: rgba(255, 255, 255, 0.98); border-radius: 16px; padding: 32px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; gap: 24px; }
    .welcome-section { text-align: center; padding: 24px; background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 12px; border: 2px solid #10b981; }
    .welcome-section h2 { font-size: 24px; color: #065f46; margin-bottom: 8px; font-weight: 700; }
    .welcome-section p { font-size: 15px; color: #047857; }
    .input-section { display: flex; flex-direction: column; gap: 16px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-size: 14px; font-weight: 600; color: #374151; }
    .input-wrapper { position: relative; }
    textarea, input[type="text"] { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; font-family: inherit; transition: all 0.3s ease; background: #ffffff; }
    textarea { min-height: 120px; resize: vertical; }
    textarea:focus, input[type="text"]:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
    .quick-options { display: flex; flex-wrap: wrap; gap: 8px; }
    .option-chip { padding: 8px 16px; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 20px; font-size: 13px; color: #4b5563; cursor: pointer; transition: all 0.2s ease; font-weight: 500; }
    .option-chip:hover { background: #e5e7eb; border-color: #10b981; color: #065f46; }
    .file-upload { border: 2px dashed #d1d5db; border-radius: 10px; padding: 24px; text-align: center; background: #f9fafb; cursor: pointer; transition: all 0.3s ease; }
    .file-upload:hover { border-color: #10b981; background: #f0fdf4; }
    .file-upload-icon { font-size: 32px; margin-bottom: 8px; }
    .file-upload p { font-size: 14px; color: #6b7280; }
    .submit-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 32px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4); }
    .submit-btn:active { transform: translateY(0); }
    .submit-btn:disabled { background: #d1d5db; cursor: not-allowed; transform: none; box-shadow: none; }
    .info-panel { display: flex; flex-direction: column; gap: 24px; }
    .card { background: rgba(255, 255, 255, 0.98); border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
    .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid #f3f4f6; }
    .card-icon { font-size: 24px; }
    .card-header h3 { font-size: 18px; font-weight: 700; color: #1f2937; }
    .weather-data { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .weather-item { background: #f9fafb; padding: 12px; border-radius: 8px; text-align: center; }
    .weather-item-icon { font-size: 24px; margin-bottom: 4px; }
    .weather-item-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 500; }
    .weather-item-value { font-size: 18px; font-weight: 700; color: #1f2937; }
    .feature-list { list-style: none; }
    .feature-list li { padding: 10px 0; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px; font-size: 14px; color: #4b5563; }
    .feature-list li:last-child { border-bottom: none; }
    .feature-icon { font-size: 18px; color: #10b981; }
    .results-section { background: rgba(255, 255, 255, 0.98); border-radius: 16px; padding: 32px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); margin-top: 24px; display: none; }
    .results-section.active { display: block; animation: slideIn 0.4s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .results-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 3px solid #10b981; }
    .results-header h2 { font-size: 24px; font-weight: 700; color: #1f2937; }
    .export-btn { background: #ffffff; color: #10b981; padding: 10px 20px; border: 2px solid #10b981; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .export-btn:hover { background: #10b981; color: white; }
    .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .analysis-card { background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 20px; border-radius: 12px; border-left: 4px solid #10b981; }
    .analysis-card h4 { font-size: 16px; font-weight: 700; color: #065f46; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .analysis-card ul { list-style: none; padding-left: 0; }
    .analysis-card li { padding: 6px 0; font-size: 14px; color: #047857; display: flex; align-items: flex-start; gap: 8px; }
    .analysis-card li:before { content: "‚úì"; color: #10b981; font-weight: bold; font-size: 16px; }
    .recommendation-box { background: #fffbeb; border: 2px solid #fbbf24; border-radius: 12px; padding: 20px; margin-top: 16px; }
    .recommendation-box h4 { font-size: 16px; font-weight: 700; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .recommendation-box p { font-size: 14px; color: #78350f; line-height: 1.6; }
    .loading-spinner { display: none; text-align: center; padding: 20px; }
    .loading-spinner.active { display: block; }
    .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #10b981; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { font-size: 15px; color: #6b7280; font-weight: 500; }
    .toast { position: fixed; bottom: 24px; right: 24px; background: #1f2937; color: white; padding: 16px 24px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); display: none; align-items: center; gap: 12px; z-index: 1000; animation: slideInRight 0.3s ease; }
    .toast.active { display: flex; }
    @keyframes slideInRight { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast-icon { font-size: 24px; }
    .toast-message { font-size: 14px; font-weight: 500; }
    @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } .info-panel { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { .container { padding: 16px; } .header-content { flex-direction: column; text-align: center; } .info-panel { grid-template-columns: 1fr; } .analysis-grid { grid-template-columns: 1fr; } .brand-text h1 { font-size: 24px; } }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo">üå±</div>
          <div class="brand-text">
            <h1 id="platform-title">WabTech AgriSense</h1>
            <p id="tagline">AI-Powered Climate-Smart Agriculture</p>
          </div>
        </div>
        <div class="header-actions">
          <div class="user-badge">üë®‚Äçüåæ Farmer Dashboard</div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Panel - Query Interface -->
      <div class="query-panel">
        <div class="welcome-section">
          <h2 id="welcome-message">Welcome, farmer! üëã</h2>
          <p>Ask questions about your crops, get AI-powered insights, and receive climate-smart recommendations</p>
        </div>
        <form id="query-form" class="input-section">
          <div class="form-group">
            <label for="query-input">What would you like to know?</label>
            <div class="input-wrapper">
              <textarea id="query-input" placeholder="Ask about crops, soil, diseases, or farm management..." required></textarea>
            </div>
          </div>
          <div class="form-group">
            <label>Quick Questions</label>
            <div class="quick-options">
              <div class="option-chip" data-query="What crops are best for my region?">üåæ Best Crops</div>
              <div class="option-chip" data-query="How can I improve soil health?">üå± Soil Health</div>
              <div class="option-chip" data-query="What are signs of common crop diseases?">ü¶† Disease Signs</div>
              <div class="option-chip" data-query="When should I irrigate my crops?">üíß Irrigation</div>
            </div>
          </div>
          <div class="form-group">
            <label for="location-input" id="location-label">Farm Location (City or Coordinates)</label> 
            <input type="text" id="location-input" placeholder="e.g., Nairobi, Kenya or 1.2921¬∞ S, 36.8219¬∞ E" required>
          </div>
          <div class="form-group">
            <label for="crop-type">Crop Type (Optional)</label> 
            <input type="text" id="crop-type" placeholder="e.g., Maize, Tomatoes, Coffee">
          </div>
          <div class="form-group">
            <label>Upload Files (Optional)</label>
            <div class="file-upload" id="file-upload">
              <div class="file-upload-icon">üì∏</div>
              <p><strong>Click to upload</strong> crop photos, soil reports, or farm logs</p>
              <p style="font-size: 12px; margin-top: 4px;">Supported: JPG, PNG, PDF (Max 5MB)</p>
            </div>
          </div>
          <button type="submit" class="submit-btn" id="submit-btn"> Get AI Recommendations üöÄ </button>
        </form>
        <div class="loading-spinner" id="loading-spinner">
          <div class="spinner"></div>
          <p class="loading-text">Analyzing climate data and generating recommendations...</p>
        </div>
      </div>

      <!-- Right Panel - Info & Weather -->
      <aside class="info-panel">
        <div class="card">
          <div class="card-header"><span class="card-icon">üå§Ô∏è</span><h3>Current Weather</h3></div>
          <div class="weather-data">
            <div class="weather-item"><div class="weather-item-icon">üå°Ô∏è</div><div class="weather-item-label">Temperature</div><div class="weather-item-value">24¬∞C</div></div>
            <div class="weather-item"><div class="weather-item-icon">üíß</div><div class="weather-item-label">Humidity</div><div class="weather-item-value">68%</div></div>
            <div class="weather-item"><div class="weather-item-icon">üåßÔ∏è</div><div class="weather-item-label">Rainfall</div><div class="weather-item-value">2mm</div></div>
            <div class="weather-item"><div class="weather-item-icon">üí®</div><div class="weather-item-label">Wind</div><div class="weather-item-value">12 km/h</div></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-icon">‚ú®</span><h3>Platform Features</h3></div>
          <ul class="feature-list">
            <li><span class="feature-icon">ü§ñ</span> Natural Language AI Assistant</li>
            <li><span class="feature-icon">üìç</span> Location-Based Recommendations</li>
            <li><span class="feature-icon">üå°Ô∏è</span> Real-Time Climate Data</li>
            <li><span class="feature-icon">üî¨</span> Disease &amp; Stress Detection</li>
            <li><span class="feature-icon">üìä</span> Exportable Reports</li>
            <li><span class="feature-icon">üåç</span> Regional Analysis Tools</li>
          </ul>
        </div>
      </aside>
    </div>

    <!-- Results Section -->
    <section class="results-section" id="results-section">
      <div class="results-header">
        <h2>üéØ AI Analysis &amp; Recommendations</h2>
        <button class="export-btn" id="export-btn">üì• Export Report</button>
      </div>
      <div class="analysis-grid">
        <div class="analysis-card">
          <h4>üîç Risk Assessment</h4>
          <ul id="risk-list">
            <li>Moderate disease pressure due to high humidity</li>
            <li>Optimal temperature range for current crop stage</li>
            <li>Adequate rainfall for growth phase</li>
          </ul>
        </div>
        <div class="analysis-card">
          <h4>üå± Identified Issues</h4>
          <ul id="issues-list">
            <li>Potential fungal infection risk in next 48 hours</li>
            <li>Soil moisture slightly below optimal range</li>
            <li>Nutrient uptake may be affected by pH levels</li>
          </ul>
        </div>
        <div class="analysis-card">
          <h4>üõ†Ô∏è Recommended Actions</h4>
          <ul id="actions-list">
            <li>Apply preventive fungicide spray within 24 hours</li>
            <li>Increase irrigation frequency to twice daily</li>
            <li>Test soil pH and adjust if needed</li>
          </ul>
        </div>
      </div>
      <div class="recommendation-box">
        <h4>üí° Climate-Smart Practices</h4>
        <p id="recommendation-text">Based on your location's climate patterns, consider implementing mulching to retain soil moisture during dry spells. Integrate cover crops during off-seasons to improve soil health and prevent erosion. Monitor weather forecasts closely and adjust irrigation schedules to optimize water use efficiency.</p>
      </div>
    </section>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"><span class="toast-icon">‚úÖ</span> <span class="toast-message" id="toast-message">Query saved successfully!</span></div>

  <script>
    const defaultConfig = {
      platform_title: "WabTech AgriSense",
      tagline: "AI-Powered Climate-Smart Agriculture",
      welcome_message: "Welcome, farmer! üëã",
      query_placeholder: "Ask about crops, soil, diseases, or farm management...",
      location_label: "Farm Location (City or Coordinates)",
      background_color: "#1e3c72",
      surface_color: "#ffffff",
      text_color: "#2d3748",
      primary_action_color: "#10b981",
      secondary_action_color: "#6b7280",
      font_family: "Inter",
      font_size: 15
    };

    let config = { ...defaultConfig };
    let queryHistory = [];

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        queryHistory = data;
        console.log('Query history updated:', data.length, 'records');
      }
    };

    // Initialize SDKs
    async function initializeSDKs() {
      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error('Failed to initialize data SDK');
        }
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...config, ...newConfig };
            updateUI(config);
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              { get: () => cfg.background_color || defaultConfig.background_color, set: (value) => { cfg.background_color = value; window.elementSdk.setConfig({ background_color: value }); } },
              { get: () => cfg.surface_color || defaultConfig.surface_color, set: (value) => { cfg.surface_color = value; window.elementSdk.setConfig({ surface_color: value }); } },
              { get: () => cfg.text_color || defaultConfig.text_color, set: (value) => { cfg.text_color = value; window.elementSdk.setConfig({ text_color: value }); } },
              { get: () => cfg.primary_action_color || defaultConfig.primary_action_color, set: (value) => { cfg.primary_action_color = value; window.elementSdk.setConfig({ primary_action_color: value }); } },
              { get: () => cfg.secondary_action_color || defaultConfig.secondary_action_color, set: (value) => { cfg.secondary_action_color = value; window.elementSdk.setConfig({ secondary_action_color: value }); } }
            ],
            borderables: [],
            fontEditable: {
              get: () => cfg.font_family || defaultConfig.font_family, set: (value) => { cfg.font_family = value; window.elementSdk.setConfig({ font_family: value }); }
            },
            fontSizeable: {
              get: () => cfg.font_size || defaultConfig.font_size, set: (value) => { cfg.font_size = value; window.elementSdk.setConfig({ font_size: value }); }
            }
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ["platform_title", cfg.platform_title || defaultConfig.platform_title],
            ["tagline", cfg.tagline || defaultConfig.tagline],
            ["welcome_message", cfg.welcome_message || defaultConfig.welcome_message],
            ["query_placeholder", cfg.query_placeholder || defaultConfig.query_placeholder],
            ["location_label", cfg.location_label || defaultConfig.location_label]
          ])
        });
      }
    }

    // Update UI based on config
    function updateUI(cfg) {
      const baseSize = cfg.font_size || defaultConfig.font_size;
      const customFont = cfg.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
      
      document.body.style.background = `linear-gradient(135deg, ${cfg.background_color || defaultConfig.background_color} 0%, #2a5298 50%, #7e8ba3 100%)`;
      
      const surfaces = document.querySelectorAll('.header, .query-panel, .card, .results-section');
      surfaces.forEach(surface => { surface.style.background = `rgba(255, 255, 255, 0.98)`; });
      
      document.querySelectorAll('.submit-btn').forEach(btn => { btn.style.background = `linear-gradient(135deg, ${cfg.primary_action_color || defaultConfig.primary_action_color}, ${cfg.primary_action_color || defaultConfig.primary_action_color})`; });
      
      document.querySelectorAll('.brand-text h1, .card-header h3, .results-header h2').forEach(el => { el.style.color = cfg.text_color || defaultConfig.text_color; });
      
      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
      
      document.querySelectorAll('.brand-text h1').forEach(el => { el.style.fontSize = `${baseSize * 1.87}px`; });
      document.querySelectorAll('.card-header h3, .results-header h2').forEach(el => { el.style.fontSize = `${baseSize * 1.2}px`; });
      document.querySelectorAll('p, textarea, input, button, label').forEach(el => { el.style.fontSize = `${baseSize}px`; });
      document.querySelectorAll('.brand-text p, .option-chip, .feature-list li').forEach(el => { el.style.fontSize = `${baseSize * 0.93}px`; });
      
      document.getElementById('platform-title').textContent = cfg.platform_title || defaultConfig.platform_title;
      document.getElementById('tagline').textContent = cfg.tagline || defaultConfig.tagline;
      document.getElementById('welcome-message').textContent = cfg.welcome_message || defaultConfig.welcome_message;
      document.getElementById('query-input').placeholder = cfg.query_placeholder || defaultConfig.query_placeholder;
      document.getElementById('location-label').textContent = cfg.location_label || defaultConfig.location_label;
    }

    // Form submission
    document.getElementById('query-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const loadingSpinner = document.getElementById('loading-spinner');
      const resultsSection = document.getElementById('results-section');
      
      const query = document.getElementById('query-input').value.trim();
      const location = document.getElementById('location-input').value.trim();
      const cropType = document.getElementById('crop-type').value.trim();
      
      if (!query || !location) {
        showToast('‚ö†Ô∏è Please fill in required fields', 3000);
        return;
      }
      
      // Show loading
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';
      loadingSpinner.classList.add('active');
      resultsSection.classList.remove('active');

      const body = { prompt: query, location, cropType };

      try {
        // USE RELATIVE PATH FOR DEPLOYMENT COMPATIBILITY
        const resp = await fetch('https://ai-agriculture-2-8lum.onrender.com/ai', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`Server error: ${resp.status} ${text}`);
        }

        const data = await resp.json();

        // Flexible parsing logic
        let aiPayload = data.result ?? data.answer ?? data.reply ?? data;

        if (typeof aiPayload === 'string') {
          const trimmed = aiPayload.trim();
          if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
            try { aiPayload = JSON.parse(trimmed); } catch (err) {}
          }
        }

        let risks = [];
        let issues = [];
        let actions = [];
        let recommendation = '';

        if (aiPayload && typeof aiPayload === 'object') {
          risks = aiPayload.risks ?? aiPayload.riskAssessment ?? aiPayload.risk ?? [];
          issues = aiPayload.issues ?? aiPayload.identifiedIssues ?? aiPayload.issuesList ?? [];
          actions = aiPayload.actions ?? aiPayload.recommendations ?? aiPayload.actionsList ?? [];
          recommendation = aiPayload.recommendation ?? aiPayload.recommendationsText ?? aiPayload.summary ?? '';
          
          if (!recommendation) {
            recommendation = Object.values(aiPayload).filter(v => typeof v === 'string').join('\n').trim();
          }
        } else if (typeof aiPayload === 'string') {
          const lines = aiPayload.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
          if (lines.length >= 3) {
            risks = lines.slice(0, 3);
            issues = lines.slice(0, Math.min(3, lines.length - 3));
            actions = lines.slice(3, 6);
            recommendation = lines.slice(6).join(' ') || lines.join(' ');
          } else {
            recommendation = aiPayload;
          }
        } else {
          recommendation = "No AI response format recognized.";
        }

        // Fill UI lists
        const fillList = (elId, arr, fallbackText) => {
          const el = document.getElementById(elId);
          if (!el) return;
          if (Array.isArray(arr) && arr.length) {
            el.innerHTML = arr.map(item => `<li>${item}</li>`).join('');
          } else {
            el.innerHTML = `<li>${fallbackText}</li>`;
          }
        };

        fillList('risk-list', risks, 'No risks identified.');
        fillList('issues-list', issues, 'No issues identified.');
        fillList('actions-list', actions, 'No specific actions recommended.');

        document.getElementById('recommendation-text').innerText = recommendation || 'No recommendation available.';

        // Save to Data SDK
        if (window.dataSdk && queryHistory.length < 999) {
          const newQuery = {
            id: Date.now().toString(),
            query,
            location,
            coordinates: extractCoordinates(location),
            timestamp: new Date().toISOString(),
            cropType: cropType || 'General',
            issueCategory: categorizeQuery(query),
            aiResponse: recommendation || (Array.isArray(actions) ? actions.join('; ') : '')
          };
          try {
            const createResult = await window.dataSdk.create(newQuery);
            if (createResult.isOk) showToast('‚úÖ Query saved successfully!', 3000);
            else showToast('‚ö†Ô∏è Could not save query', 3000);
          } catch (errSave) {
            console.warn('dataSdk.create error', errSave);
          }
        }

        loadingSpinner.classList.remove('active');
        resultsSection.classList.add('active');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Get AI Recommendations üöÄ';
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch (err) {
        console.error('Request error', err);
        loadingSpinner.classList.remove('active');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Get AI Recommendations üöÄ';
        showToast(`‚ùå ${err.message}`, 5000);
      }
    });

    // Quick option chips
    document.querySelectorAll('.option-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.getElementById('query-input').value = chip.dataset.query;
      });
    });

    document.getElementById('file-upload').addEventListener('click', () => {
      showToast('üìé File upload simulated (demo only)', 2000);
    });

    document.getElementById('export-btn').addEventListener('click', () => {
      showToast('üì• Report export simulated (demo only)', 2000);
    });

    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      toastMessage.textContent = message;
      toast.classList.add('active');
      setTimeout(() => { toast.classList.remove('active'); }, duration);
    }

    function extractCoordinates(location) {
      const coordPattern = /(-?\d+\.?\d*)[¬∞,\s]+([NS]?)[,\s]*(-?\d+\.?\d*)[¬∞,\s]+([EW]?)/i;
      const match = location.match(coordPattern);
      if (match) return `${match[1]}¬∞${match[2]}, ${match[3]}¬∞${match[4]}`;
      return location;
    }

    function categorizeQuery(query) {
      const lowerQuery = (query || '').toLowerCase();
      if (lowerQuery.includes('disease') || lowerQuery.includes('pest')) return 'Disease/Pest';
      if (lowerQuery.includes('soil') || lowerQuery.includes('fertilizer')) return 'Soil Management';
      if (lowerQuery.includes('water') || lowerQuery.includes('irrigat')) return 'Irrigation';
      if (lowerQuery.includes('crop') || lowerQuery.includes('plant')) return 'Crop Selection';
      return 'General';
    }

    initializeSDKs();
    updateUI(config);
  </script>
</body>
</html>
